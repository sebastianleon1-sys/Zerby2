<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Zerby - Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap + tema -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
</head>
<body class="app-body">

<header class="app-navbar">
    <div class="app-navbar-inner">
        <a href="/" class="app-logo">
            <img src="{{ url_for('static', filename='logo_zerby_white.png') }}" alt="Zerby Logo">
            
        </a>
        <div class="app-nav-links">
            <a href="/dashboard">Dashboard</a>
            <a href="/bandeja_entrada" class="primary">Mensajes</a>
            <a href="/api/logout">Cerrar sesión</a>
        </div>
    </div>
</header>

<main class="app-main">
    <div class="chat-container app-card">
        <div class="chat-header">
            <div>
                <a href="/bandeja_entrada" class="text-muted-soft back-link">&larr; Volver</a>
                <h5 class="mb-0 mt-1" id="chat-with-name">Cargando...</h5>
            </div>

            {% if user_tipo_actual == 'usuario' %}
            <div class="rating-widget">
                <span class="rating-label">Calificar (1-7):</span>
                <div class="stars" id="stars-widget">
                    <span data-value="1">⭐</span>
                    <span data-value="2">⭐</span>
                    <span data-value="3">⭐</span>
                    <span data-value="4">⭐</span>
                    <span data-value="5">⭐</span>
                    <span data-value="6">⭐</span>
                    <span data-value="7">⭐</span>
                </div>
                <input type="text" id="rating-comment"
                       placeholder="Deja un comentario (opcional)"
                       class="form-control rating-comment-input">
            </div>
            {% endif %}
        </div>
        
        <div class="chat-box" id="chat-box"></div>

        <form class="chat-form" id="form-enviar">
            <input type="text" id="input-mensaje" class="form-control"
                   placeholder="Escribe un mensaje..." autocomplete="off">
            <button type="submit" class="btn btn-primary">Enviar</button>
        </form>
    </div>
</main>

<!-- Socket.IO -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
    const CONV_ID = {{ conv_id|tojson }};
    const USER_TIPO_ACTUAL = {{ user_tipo_actual|tojson }};

    const chatBox = document.getElementById('chat-box');
    const chatName = document.getElementById('chat-with-name');
    const form = document.getElementById('form-enviar');
    const inputMsg = document.getElementById('input-mensaje');

    const socket = io("/", { transports: ['websocket'] });

    socket.on("connect", () => {
        socket.emit("join", { conv_id: CONV_ID });
    });

    socket.off("receive_message");
    socket.on("receive_message", data => {
        addMessage(data.contenido, data.remitente_tipo, data.timestamp);
    });

    async function cargarMensajes() {
        const response = await fetch(`/api/conversacion/${CONV_ID}/detalles`);
        const data = await response.json();

        chatName.textContent = `Chat con ${data.otro_nombre}`;
        chatBox.innerHTML = '';

        data.mensajes.forEach(msg => addMessage(msg.contenido, msg.remitente_tipo, msg.timestamp));
        chatBox.scrollTop = chatBox.scrollHeight;

        if (data.proveedor_id) {
            setupRatingWidget(data.proveedor_id);
        }
    }

    function addMessage(text, remitente_tipo, ts = null) {
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('mensaje', (remitente_tipo === USER_TIPO_ACTUAL) ? 'enviado' : 'recibido');

        if (!ts) {
            const f = new Date();
            ts = f.toLocaleDateString() + " " + f.toLocaleTimeString().slice(0,5);
        }
        msgDiv.innerHTML = `
            <span class="mensaje-texto">${text}</span>
            <span class="timestamp">${ts}</span>
        `;
        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function setupRatingWidget(proveedorId) {
        const starsContainer = document.getElementById("stars-widget");
        if (!starsContainer) return;

        const stars = starsContainer.querySelectorAll("span");

        const sendRating = async (puntuacion) => {
            const commentInput = document.getElementById("rating-comment");
            const comentario = commentInput.value.trim();
            try {
                const response = await fetch(`/api/calificar/${proveedorId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ puntuacion, comentario })
                });

                const data = await response.json();

                if (response.ok) {
                    starsContainer.classList.add("rated");
                    stars.forEach((star, index) => {
                        star.classList.toggle("active", index < puntuacion);
                    });
                } else {
                    alert("Error al enviar calificación: " + data.error);
                }
            } catch (e) {
                console.error("Error al calificar:", e);
                alert("Error de red al calificar.");
            }
        };

        stars.forEach(star => {
            star.addEventListener("click", () => {
                const value = parseInt(star.dataset.value, 10);
                sendRating(value);
            });
        });
    }

    async function enviarMensaje(e) {
        e.preventDefault();
        const contenido = inputMsg.value.trim();
        if (!contenido) return;

        try {
            await fetch(`/api/conversacion/${CONV_ID}/enviar`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contenido })
            });
            inputMsg.value = "";
        } catch (e) {
            console.error(e);
        }
    }

    window.addEventListener('load', cargarMensajes);
    form.addEventListener('submit', enviarMensaje);
</script>

</body>
</html>
