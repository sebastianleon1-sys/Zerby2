<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Zerby - Perfil de {{ proveedor_nombre }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <!-- Bootstrap + tema -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
</head>

<body class="app-body">
<header class="app-navbar">
    <div class="app-navbar-inner">
        <a href="/" class="app-logo">
            <img src="{{ url_for('static', filename='logo_zerby_white.png') }}" alt="Zerby Logo">
            
        </a>
        <div class="app-nav-links">
            <a href="/bandeja_entrada">Mis mensajes</a>
            <a href="/api/logout" class="primary">Cerrar sesi√≥n</a>
        </div>
    </div>
</header>

<main class="app-main">
    <div class="profile-layout" id="top">
        <!-- Columna izquierda: perfil completo -->
        <div class="profile-container" id="profile-container">
            <p class="text-muted-soft">Cargando perfil del proveedor...</p>
        </div>

        <!-- Columna derecha: panel de agenda -->
        <aside class="agenda-panel" id="agenda-panel">
            <h3 class="agenda-title">Agendar servicio</h3>
            <p id="agenda-horario-referencia" class="agenda-horario-ref text-muted-soft"></p>

            <form id="form-agenda" class="agenda-form">
                <div class="mb-3">
                    <label class="form-label">Fecha</label>
                    <input type="date" class="form-control" id="agenda-fecha" name="fecha" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Hora de inicio</label>
                    <input type="time" class="form-control" id="agenda-hora-inicio" name="hora_inicio" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Hora de t√©rmino</label>
                    <input type="time" class="form-control" id="agenda-hora-fin" name="hora_fin" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Describe tu necesidad</label>
                    <textarea
                        class="form-control"
                        id="agenda-descripcion"
                        name="descripcion"
                        rows="4"
                        placeholder="Ej: Fuga en lavamanos del ba√±o principal, necesito que lo revisen esta tarde.">
                    </textarea>
                </div>

                <button type="submit" class="btn btn-primary w-100">
                    Enviar solicitud
                </button>

                <div id="agenda-msg" class="agenda-msg"></div>
            </form>
        </aside>
    </div>
</main>

<script>
    const PROVEEDOR_ID = {{ proveedor_id|tojson }};
    let proveedorData = null;

    // Cargar perfil
    window.addEventListener('load', async function() {
        const container = document.getElementById('profile-container');

        try {
            const response = await fetch(`/api/perfil/proveedor/${PROVEEDOR_ID}`);
            if (!response.ok) throw new Error('No se pudo cargar el perfil');

            const data = await response.json();
            proveedorData = data;

            renderProfile(container, data);
            initAgendaPanel(data);

        } catch (e) {
            console.error(e);
            container.innerHTML = '<p class="text-error-soft">Error al cargar el perfil. Es posible que el proveedor no exista.</p>';
        }
    });

    function renderProfile(container, data) {
        let urgenciaBadge = data.atiende_urgencias
            ? '<span class="badge-urgente">Atiende Urgencias</span>'
            : '';

        let ratingSummary = `‚≠ê <strong>${data.calif_promedio} / 7</strong> 
            <span class="rating-count">(${data.calif_total} ${data.calif_total === 1 ? 'opini√≥n' : 'opiniones'})</span>`;

        if (data.calif_total === 0) {
            ratingSummary = '<span class="rating-count">(Sin opiniones a√∫n)</span>';
        }

        // Portafolio
        let portfolioHtml = '<h3 class="section-title">Portafolio</h3>';
        if (data.portafolio.length > 0) {
            portfolioHtml += '<div class="portfolio-grid">';
            data.portafolio.forEach(item => {
                portfolioHtml += `
                    <div class="portfolio-item">
                        <img src="${item.imagen_url}" alt="${item.descripcion || 'Trabajo'}">
                        <p class="portfolio-caption">${item.descripcion || 'Trabajo realizado'}</p>
                    </div>
                `;
            });
            portfolioHtml += '</div>';
        } else {
            portfolioHtml += '<p class="text-muted-soft">Este proveedor a√∫n no ha subido fotos de sus trabajos.</p>';
        }

        // Calificaciones
        let ratingsHtml = '<h3 class="section-title">Opiniones de clientes</h3>';
        if (data.calificaciones.length > 0) {
            ratingsHtml += '<div class="rating-list">';
            data.calificaciones.forEach(calif => {
                const stars = '‚≠ê'.repeat(calif.puntuacion);
                const emptyStars = '‚òÜ'.repeat(7 - calif.puntuacion);
                ratingsHtml += `
                    <div class="rating-card">
                        <div class="stars">${stars}<span class="stars-empty">${emptyStars}</span></div>
                        <p class="comment">"${calif.comentario || 'Sin comentario.'}"</p>
                        <span class="author">- ${calif.nombre_usuario} (${calif.timestamp})</span>
                    </div>
                `;
            });
            ratingsHtml += '</div>';
        } else {
            ratingsHtml += '<p class="text-muted-soft">Este proveedor a√∫n no ha recibido opiniones.</p>';
        }

        container.innerHTML = `
            <section class="profile-header">
                <h1 class="profile-name">${data.nombre}</h1>
                <p class="profile-oficio">${data.oficio} ${urgenciaBadge}</p>
                <p class="rating-summary">${ratingSummary}</p>
                <hr>
                <p class="profile-description">${data.descripcion || 'Sin descripci√≥n.'}</p>
                <p><strong>üìç Direcci√≥n:</strong> ${data.direccion || 'No especificada'}</p>
                <p><strong>üïí Horario:</strong> ${data.horario || 'No especificado'}</p>
                <p><strong>üìû Contacto:</strong> ${data.telefono}</p>
            </section>

            <section class="profile-section">
                ${portfolioHtml}
            </section>
            
            <section class="profile-section">
                ${ratingsHtml}
            </section>
        `;
    }

    function initAgendaPanel(data) {
        const horarioRef = document.getElementById('agenda-horario-referencia');
        if (horarioRef) {
            horarioRef.textContent = data.horario
                ? `Horario de referencia del proveedor: ${data.horario}`
                : 'Horario de referencia no especificado por el proveedor.';
        }

        const fechaInput = document.getElementById('agenda-fecha');
        if (fechaInput) {
            const hoy = new Date().toISOString().split('T')[0];
            fechaInput.min = hoy;
        }
    }

    // Env√≠o del formulario de agenda
    document.addEventListener('DOMContentLoaded', () => {
        const formAgenda = document.getElementById('form-agenda');
        const msgBox = document.getElementById('agenda-msg');

        if (!formAgenda) return;

        formAgenda.addEventListener('submit', async (e) => {
            e.preventDefault();

            const fecha = document.getElementById('agenda-fecha').value;
            const hora_inicio = document.getElementById('agenda-hora-inicio').value;
            const hora_fin = document.getElementById('agenda-hora-fin').value;
            const descripcion = document.getElementById('agenda-descripcion').value;

            msgBox.textContent = 'Enviando solicitud...';
            msgBox.className = 'agenda-msg agenda-msg-pending';

            try {
                const resp = await fetch(`/api/proveedores/${PROVEEDOR_ID}/solicitudes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fecha, hora_inicio, hora_fin, descripcion })
                });

                const data = await resp.json();

                if (!resp.ok) {
                    throw new Error(data.error || 'Error al enviar la solicitud');
                }

                msgBox.textContent = 'Solicitud enviada correctamente, redireccionando...';
                msgBox.className = 'agenda-msg agenda-msg-success';

                // Siempre que la solicitud se cree bien, rediriges
                setTimeout(() => {
                    window.location.href = "/mis_solicitudes";
                }, 900);

                formAgenda.reset();


            } catch (err) {
                console.error(err);
                msgBox.textContent = err.message || 'Error al enviar la solicitud.';
                msgBox.className = 'agenda-msg agenda-msg-error';
            }
        });
    });
</script>

</body>
</html>
