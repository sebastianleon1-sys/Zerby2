<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registro de Cliente - Zerby</title>

    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Tema global -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
</head>
<body class="auth-page">

<main class="auth-main">
    <section class="auth-card auth-card-narrow">
        <div class="auth-logo-wrapper">
            <img src="{{ url_for('static', filename='logo_zerby_inverted.png') }}" alt="Zerby Logo" class="auth-logo">
        </div>

        <h2 class="auth-title">Soy cliente (busco un servicio)</h2>
        <p class="auth-back-link">
            <a href="/">&larr; Volver al inicio</a>
        </p>

        <form id="form-usuario" class="auth-form">
            <div class="mb-3">
                <label class="form-label">Nombre completo</label>
                <input type="text" name="nombre_completo" class="form-control" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" name="email" class="form-control" required autocomplete="email">
            </div>

            <div class="mb-3">
                <label class="form-label">Contraseña</label>
                <input type="password" name="password" class="form-control" required autocomplete="new-password">
            </div>

            <div class="mb-3">
                <label class="form-label">Teléfono (opcional)</label>
                <input type="tel" name="telefono" class="form-control">
            </div>

            <div class="mb-3 position-relative">
                <label class="form-label" for="direccion">Dirección (para geolocalización)</label>
                <input 
                    type="text" 
                    id="direccion" 
                    name="direccion" 
                    class="form-control"
                    placeholder="Ej: Calle 123, Santiago" 
                    autocomplete="off"
                    required
                >
                <ul 
                    id="direccion-sugerencias" 
                    class="list-group suggestions-list"
                ></ul>
            </div>

            <!-- Campos ocultos para lat/lon -->
            <input type="hidden" id="lat" name="lat">
            <input type="hidden" id="lon" name="lon">

            <button type="submit" class="btn btn-primary w-100 auth-submit-btn">
                Registrarme como cliente
            </button>

            <p class="auth-footer-text">
                ¿Ya tienes cuenta? <a href="/login">Inicia sesión</a><br>
                ¿Ofreces un servicio? <a href="/registro/proveedor">Regístrate como proveedor</a>
            </p>
        </form>
    </section>
</main>

<script>
    const direccionInput = document.getElementById('direccion');
    const sugerenciasList = document.getElementById('direccion-sugerencias');
    const latInput = document.getElementById('lat');
    const lonInput = document.getElementById('lon');

    let debounceTimeout = null;
    let currentController = null;

    direccionInput.addEventListener('input', () => {
        const query = direccionInput.value.trim();
        clearTimeout(debounceTimeout);

        if (!query || query.length < 4) {
            sugerenciasList.innerHTML = '';
            latInput.value = '';
            lonInput.value = '';
            return;
        }

        debounceTimeout = setTimeout(() => {
            if (currentController) {
                currentController.abort();
            }
            currentController = new AbortController();

            fetch(`/api/geocode/search?q=${encodeURIComponent(query)}`, {
                signal: currentController.signal
            })
                .then(res => {
                    if (!res.ok) throw new Error('Respuesta no OK');
                    return res.json();
                })
                .then(data => {
                    sugerenciasList.innerHTML = '';

                    data.forEach(item => {
                        const li = document.createElement('li');
                        li.textContent = item.display_name;
                        li.classList.add('list-group-item', 'suggestion-item');

                        li.addEventListener('click', () => {
                            direccionInput.value = item.display_name;
                            latInput.value = item.lat;
                            lonInput.value = item.lon;
                            sugerenciasList.innerHTML = '';
                        });

                        sugerenciasList.appendChild(li);
                    });
                })
                .catch(err => {
                    if (err.name !== 'AbortError') {
                        console.error('Error fetch geocode:', err);
                    }
                    sugerenciasList.innerHTML = '';
                });
        }, 600);
    });

    document.addEventListener('click', (e) => {
        if (!sugerenciasList.contains(e.target) && e.target !== direccionInput) {
            sugerenciasList.innerHTML = '';
        }
    });

    document.getElementById('form-usuario').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const datos = Object.fromEntries(formData.entries());

        const response = await fetch('/registrar/usuario', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(datos)
        });
        
        const resultado = await response.json();

        if (response.ok) {
            alert(resultado.mensaje || 'Usuario registrado con éxito.');
            window.location.href = '/dashboard'; 
        } else {
            alert(resultado.mensaje || 'Error al registrar');
        }
    });
</script>

</body>
</html>
