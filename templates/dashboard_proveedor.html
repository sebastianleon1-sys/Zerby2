<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Zerby - Panel de Proveedor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap + tema -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
</head>
<body class="app-body">

<header class="app-navbar">
    <div class="app-navbar-inner">
        <a href="/" class="app-logo">
            <img src="{{ url_for('static', filename='logo_zerby_white.png') }}" alt="Zerby Logo">
            
        </a>
        <div class="app-nav-links">
            <a href="/dashboard" class="primary">Panel proveedor</a>
            <a href="/solicitudes">Solicitudes</a>
            <a href="/bandeja_entrada">Mensajes</a>
            <a href="/api/logout">Cerrar sesión</a>
        </div>
    </div>
</header>

<main class="app-main">
    <div class="app-card mb-4">
        <div class="app-card-header">
            <div>
                <div class="app-card-title" id="welcome-msg">
                    ¡Hola, <span>cargando...</span>!
                </div>
                <div class="app-card-subtitle">
                    Gestiona tu portafolio y las solicitudes de clientes.
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-12 col-lg-7">
            <div class="app-card">
                <h4 class="mb-3">Tu portafolio</h4>
                <form class="mb-4" id="form-add-portfolio">
                    <div class="mb-2">
                        <label class="form-label">Foto de un trabajo</label>
                        <input type="file" id="input-imagen-file" accept="image/*" required class="form-control">
                    </div>
                    <div class="mb-2">
                        <input type="text" id="input-imagen-desc" class="form-control"
                               placeholder="Descripción (ej: 'Reparación de lavamanos')">
                    </div>
                    <button type="submit" class="btn btn-primary w-100 mt-2">Subir foto al portafolio</button>
                </form>

                <h5 class="mb-3">Trabajos actuales</h5>
                <div class="portfolio-grid" id="portfolio-grid">
                    <p class="text-muted-soft">Cargando trabajos...</p>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-5">
            <div class="app-card">
                <h4 class="mb-3">Solicitudes recientes</h4>
                <div id="solicitudes-list">
                    <p class="text-muted-soft">Cargando solicitudes...</p>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    const portfolioGrid = document.getElementById('portfolio-grid');

    window.addEventListener('load', async function() {
        let profileData;
        try {
            const responseProfile = await fetch('/api/get_profile');
            if (!responseProfile.ok) throw new Error('No autorizado');
            profileData = await responseProfile.json();
            
            document.querySelector('#welcome-msg span').textContent = profileData.nombre;

        } catch (e) {
            window.location.href = '/login';
            return;
        }

        // Cargar portafolio usando el ID del proveedor entregado por /api/get_profile
        try {
            const responseData = await fetch(`/api/perfil/proveedor/${profileData.id}`);
            if (!responseData.ok) throw new Error('Error cargando datos');
            
            const data = await responseData.json();
            mostrarPortafolio(data.portafolio);

        } catch (e) {
            console.error(e);
            portfolioGrid.innerHTML = "<p class='text-error-soft'>Error al cargar tu portafolio.</p>";
        }

        loadSolicitudesServicio();
    });

    function mostrarPortafolio(items) {
        portfolioGrid.innerHTML = '';
        if (!items.length) {
            portfolioGrid.innerHTML = "<p class='text-muted-soft'>Aún no has subido trabajos a tu portafolio.</p>";
            return;
        }
        items.forEach(item => agregarItemGrid(item));
    }

    function agregarItemGrid(item) {
        const div = document.createElement('div');
        div.className = 'portfolio-item';
        div.id = `item-${item.id}`;
        div.innerHTML = `
            <img src="${item.imagen_url}" alt="${item.descripcion || 'Trabajo'}">
            <p class="portfolio-caption">
                <span>${item.descripcion || 'Sin descripción'}</span>
                <button class="btn btn-sm btn-outline-danger" onclick="eliminarTrabajo(${item.id})">Eliminar</button>
            </p>
        `;
        portfolioGrid.appendChild(div);
    }

    document.getElementById('form-add-portfolio').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('input-imagen-file');
        const descInput = document.getElementById('input-imagen-desc');

        if (!fileInput.files.length) {
            alert("Por favor selecciona un archivo");
            return;
        }

        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append('imagen', file);
        formData.append('descripcion', descInput.value);

        try {
            const response = await fetch('/api/portafolio/add', {
                method: 'POST',
                body: formData 
            });
            
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Error al añadir');

            agregarItemGrid(data.item);
            document.getElementById('form-add-portfolio').reset();

        } catch (e) {
            console.error(e);
            alert(e.message);
        }
    });

    async function eliminarTrabajo(itemId) {
        if (!confirm('¿Estás seguro de que quieres eliminar este trabajo?')) return;
        
        try {
            const response = await fetch(`/api/portafolio/delete/${itemId}`, {
                method: 'DELETE'
            });
            const data = await response.json();

            if (!response.ok) throw new Error(data.error || 'Error al eliminar');

            document.getElementById(`item-${itemId}`).remove();
            alert(data.mensaje);

        } catch (e) {
            console.error(e);
            alert(e.message);
        }
    }

    async function loadSolicitudesServicio() {
        const cont = document.getElementById('solicitudes-list');
        cont.innerHTML = '<p class="text-muted-soft">Cargando solicitudes...</p>';

        try {
            const resp = await fetch('/api/solicitudes/proveedor');
            if (!resp.ok) {
                const dataError = await resp.json().catch(() => ({}));
                throw new Error(dataError.error || 'Error al cargar solicitudes');
            }

            const solicitudes = await resp.json();
            if (!solicitudes.length) {
                cont.innerHTML = '<p class="text-muted-soft">No tienes solicitudes por ahora.</p>';
                return;
            }

            cont.innerHTML = '';
            solicitudes.forEach(s => {
                const card = document.createElement('div');
                card.className = 'solicitud-card mb-2';
                card.id = `solicitud-${s.id}`;

                card.innerHTML = `
                    <div class="solicitud-header">
                        <div>
                            <strong>Cliente:</strong> ${s.cliente}<br>
                            <small class="text-muted-soft">${s.creado_en}</small>
                        </div>
                        <span class="solicitud-estado ${s.estado}">${s.estado.toUpperCase()}</span>
                    </div>
                    <p class="mb-1"><strong>Fecha:</strong> ${s.fecha}</p>
                    <p class="mb-1"><strong>Horario:</strong> ${s.hora_inicio} - ${s.hora_fin}</p>
                    <p class="mb-0"><strong>Detalle:</strong> ${s.descripcion || 'Sin descripción adicional.'}</p>
                    <div class="solicitud-actions mt-2">
                        <button class="btn btn-sm btn-success" 
                            onclick="actualizarEstadoSolicitud(${s.id}, 'aceptada')" 
                            ${s.estado !== 'pendiente' ? 'disabled' : ''}>
                            Aceptar
                        </button>
                        <button class="btn btn-sm btn-outline-danger" 
                            onclick="actualizarEstadoSolicitud(${s.id}, 'rechazada')" 
                            ${s.estado !== 'pendiente' ? 'disabled' : ''}>
                            Rechazar
                        </button>
                    </div>
                `;
                cont.appendChild(card);
            });

        } catch (e) {
            console.error(e);
            cont.innerHTML = '<p class="text-error-soft">Error al cargar las solicitudes.</p>';
        }
    }

    async function actualizarEstadoSolicitud(id, nuevoEstado) {
        if (!confirm(`¿Seguro que quieres marcar esta solicitud como "${nuevoEstado}"?`)) return;

        try {
            const resp = await fetch(`/api/solicitudes/${id}/estado`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ estado: nuevoEstado })
            });

            const data = await resp.json();
            if (!resp.ok) throw new Error(data.error || 'Error al actualizar estado');

            await loadSolicitudesServicio();

        } catch (e) {
            console.error(e);
            alert(e.message);
        }
    }
</script>

</body>
</html>
