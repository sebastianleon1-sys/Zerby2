<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Zerby - Mi Panel de Proveedor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        nav { display: flex; justify-content: space-between; align-items: center; }
        
        /* Estilos para el portafolio */
        .portfolio-manager {
            max-width: 900px;
            margin: 20px 0;
        }
        .form-add-portfolio {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .form-add-portfolio input {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .form-add-portfolio button {
            padding: 10px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .portfolio-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .portfolio-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        .portfolio-item img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            display: block;
        }
        .portfolio-item p {
            padding: 10px;
            font-size: 14px;
            margin: 0;
            background: #fdfdfd;
        }
        .portfolio-item .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-weight: bold;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .portfolio-item .delete-btn:hover { opacity: 1; }
    </style>
</head>
<body>

    <nav>
        <h1 id="welcome-msg">¡Hola, <span>cargando...</span>!</h1>
        <div>
            <a id="ver-mi-perfil-link" href="#" style="margin-right: 15px; display: none;">Ver mi Perfil Público</a>
            <a href="/bandeja_entrada" style="margin-right: 15px;">Bandeja de Entrada</a>
            <a href="/api/logout">Cerrar Sesión</a>
        </div>
    </nav>
    <hr>
    
    <h2>Tu Panel de Proveedor</h2>
    <p>Gestiona los trabajos de tu portafolio. Estos se mostrarán en tu perfil público.</p>

    <div class="portfolio-manager">
        
        <form class="form-add-portfolio" id="form-add-portfolio">
            <h4>Añadir nuevo trabajo al portafolio</h4>
            
            <label for="input-imagen-file" style="font-size: 0.9em; margin-bottom:5px;">Selecciona una foto:</label>
            <input type="file" id="input-imagen-file" accept="image/*" required>
            
            <input type="text" id="input-imagen-desc" placeholder="Descripción (ej: 'Reparación de lavamanos')">
            <button type="submit">Subir Foto</button>
        </form>

        <h3 style="margin-top: 30px;">Tus Trabajos Actuales</h3>
        <div class="portfolio-grid" id="portfolio-grid">
            <p>Cargando trabajos...</p>
        </div>
    </div>

<script>
    const portfolioGrid = document.getElementById('portfolio-grid');

    window.addEventListener('load', async function() {
        let profileData;
        try {
            // 1. Cargar datos del perfil (nombre, etc.)
            const responseProfile = await fetch('/api/get_profile');
            if (!responseProfile.ok) throw new Error('No autorizado');
            profileData = await responseProfile.json();
            
            document.querySelector('#welcome-msg span').textContent = profileData.nombre;
            const linkPerfil = document.getElementById('ver-mi-perfil-link');
            linkPerfil.href = `/perfil/proveedor/${profileData.id}`;
            linkPerfil.style.display = 'inline-block';

        } catch (e) {
            window.location.href = '/login';
            return;
        }

        // 2. Cargar datos del portafolio (usamos la API pública)
        try {
            const responsePortfolio = await fetch(`/api/perfil/proveedor/${profileData.user_id_debes_pasarlo_de_get_profile}`);
            // --- OJO: /api/get_profile DEBE DEVOLVER EL ID DEL USUARIO ---
            // --- VAMOS A ASUMIR QUE USAMOS EL ID DE LA SESIÓN ---
            
            // Corrección: /api/get_profile no nos da el ID.
            // PERO /api/perfil/proveedor usa el ID del proveedor, 
            // y como estamos logueados como proveedor, ¡podemos usar la API!
            
            // La API /api/get_profile es limitada. Usaremos la API del perfil público
            // pero le pasaremos el ID que tenemos... un momento.
            // ¡/api/get_profile no nos da nuestro propio ID!
            
            // --- ¡GRAN PROBLEMA Y SOLUCIÓN! ---
            // Modificaremos /api/get_profile en app.py para que devuelva el ID
            
            // (Añade "id": user.id en el return jsonify de /api/get_profile)
            // Asumamos que ya hiciste ese cambio (ver Paso 7)
            
            const responseData = await fetch(`/api/perfil/proveedor/${profileData.id}`);
            if (!responseData.ok) throw new Error('Error cargando datos');
            
            const data = await responseData.json();
            mostrarPortafolio(data.portafolio);

        } catch (e) {
            console.error(e);
            portfolioGrid.innerHTML = "<p>Error al cargar tu portafolio.</p>";
        }
    });

    function mostrarPortafolio(items) {
        portfolioGrid.innerHTML = '';
        if (items.length === 0) {
            portfolioGrid.innerHTML = "<p>Aún no has subido trabajos a tu portafolio.</p>";
            return;
        }
        items.forEach(item => {
            agregarItemGrid(item);
        });
    }

    function agregarItemGrid(item) {
        const div = document.createElement('div');
        div.className = 'portfolio-item';
        div.id = `item-${item.id}`;
        div.innerHTML = `
            <img src="${item.imagen_url}" alt="${item.descripcion || 'Trabajo'}">
            <p>${item.descripcion || 'Sin descripción'}</p>
            <button class="delete-btn" onclick="eliminarTrabajo(${item.id})">X</button>
        `;
        portfolioGrid.appendChild(div);
    }

    // --- Lógica de Formularios ---

    document.getElementById('form-add-portfolio').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('input-imagen-file');
        const descInput = document.getElementById('input-imagen-desc');

        if (fileInput.files.length === 0) {
            alert("Por favor selecciona un archivo");
            return;
        }

        const file = fileInput.files[0];
        
        // 1. Crear FormData para enviar archivos
        const formData = new FormData();
        formData.append('imagen', file); // 'imagen' debe coincidir con request.files['imagen'] en Flask
        formData.append('descripcion', descInput.value);

        try {
            // Nota: Al enviar FormData, NO ponemos 'Content-Type': 'application/json'
            // El navegador lo configura automáticamente como multipart/form-data
            const response = await fetch('/api/portafolio/add', {
                method: 'POST',
                body: formData 
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Error al añadir');
            }
            
            agregarItemGrid(data.item); // Añadimos el nuevo item al grid
            document.getElementById('form-add-portfolio').reset(); // Limpiamos form

        } catch (e) {
            console.error(e);
            alert(e.message);
        }
    });

    async function eliminarTrabajo(itemId) {
        if (!confirm('¿Estás seguro de que quieres eliminar este trabajo?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/portafolio/delete/${itemId}`, {
                method: 'DELETE'
            });
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Error al eliminar');
            }

            document.getElementById(`item-${itemId}`).remove(); // Elimina del DOM
            alert(data.mensaje);

        } catch (e) {
            console.error(e);
            alert(e.message);
        }
    }
</script>

</body>
</html>